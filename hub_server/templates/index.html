<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hub+ Admin Page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f0f2f5;
            font-family: 'Segoe UI', sans-serif;
        }
        .container {
            margin-top: 50px;
        }
        .card {
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
<div class="container">
    <div class="card p-4">
        <h2 class="mb-3 text-center">Hub+ Wi-Fi Manager</h2>
        <p><strong>Currently Connected SSID:</strong> 
        <!-- Add a spinner for getting the current SSID. While it should be short, that will allow
         user to know why the value is blank. Will overwrite with the value once it is connected. -->
        <span id="current-ssid">
            <span class="d-inline-flex align-items-center">
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Getting Current SSID...
            </span>
        </span>
        </p>
        <!-- Scan for the wifi networks -->
        <button class="btn btn-primary mb-3" onclick="scanNetworks()">Scan Networks</button>
        <div id="scan-result" class="mb-3"></div>
        <!-- User's choice for the wifi network available. Allow user to put in password as well -->
        <form onsubmit="connectWifi(event)">
            <div class="mb-3">
                <label for="ssid" class="form-label">Select SSID:</label>
                <select id="ssid" class="form-select"></select>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Password:</label>
                <input type="password" id="password" class="form-control" required>
            </div>
            <!-- Run the NMCLI command to try and connect user the ssid/password given -->
            <button class="btn btn-success">Connect</button>
        </form>
        <!--  Output the success/fail of the nmcli commands -->
        <div id="connect-status" class="mt-3"></div>
    </div>
    <!-- Start the upload config file section -->
    <div class="card p-4 mt-4">
        <h3 class="text-center">Upload config file for hub+</h3>
        <!-- Form for uploading the config file -->
        <form id="upload-form" enctype="multipart/form-data" onsubmit="uploadConfigFile(event)">
            <div class="mb-3">
                <label for="config-file" class="form-label">Select config file:</label>
                <!-- TODO: Change to only accept .zcf since that is config file format -->
                <input type="file" id="config-file" name="config-file" class="form-control" accept=".json" required />
            </div>
            <!-- Button to upload the file -->
            <button type="submit" class="btn btn-success">Upload Config</button>
        </form>
        <!-- Output the success/fail of the file upload process -->
        <div id="upload-status" class="mt-3"></div>
    </div>
</div>

<script>
    // Function to handle the file upload
    async function uploadConfigFile(event) {
        event.preventDefault();
        // Get the page elements
        const form = document.getElementById('upload-form');
        const formData = new FormData(form);
        const fileInput = document.getElementById('config-file');
        const statusEl = document.getElementById('upload-status');
        statusEl.innerHTML = '';

        // Check if a file is selected
        if (!fileInput.files.length) {
            statusEl.innerHTML = `<div class="alert alert-warning">Please select a file to upload.</div>`;
            return;
        }
        // Create the formdata object to send the file
        const res = await fetch('/upload_config', {
            method: 'POST',
            body: formData
        });

        // Check the response from the server and update the status
        const data = await res.json();
        if (data.error) {
            statusEl.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        } else {
            statusEl.innerHTML = `<div class="alert alert-success">Config file uploaded successfully!</div>`;
        }
    }

    // Fetch the current SSID and display it
    async function fetchCurrentSSID() {
        const res = await fetch('/current_ssid');
        const data = await res.json();
        document.getElementById('current-ssid').textContent = data.output || data.error;
    }

    // Function to scan for available Wi-Fi networks
    async function scanNetworks() {
        // Get the elements for displaying results and clearing previous results
        const resultEl = document.getElementById('scan-result');
        const ssidSelect = document.getElementById('ssid');
        ssidSelect.innerHTML = '';
        // Show a loading spinner while scanning
        resultEl.innerHTML = `<div class="d-flex align-items-center"><span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Scanning...</div>`;

        // Make the scan request to the server
        const res = await fetch('/scan');
        const data = await res.json();
        resultEl.innerHTML = '';

        // Check if there was an error in the response
        if (data.error) {
            resultEl.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
            return;
        }

        // Populate the SSID dropdown with the scanned networks
        const ssids = data.ssids || [];
        ssids.forEach(ssid => {
            const opt = document.createElement('option');
            opt.value = ssid;
            opt.textContent = ssid;
            ssidSelect.appendChild(opt);
        });

        // Show the number of networks found
        resultEl.innerHTML = `<div class="alert alert-info">${ssids.length} networks found</div>`;
    }

    // Function to connect to the selected Wi-Fi network
    async function connectWifi(e) {
        e.preventDefault();
        // Get the SSID and password from the form as well as the status element
        const ssid = document.getElementById('ssid').value;
        const password = document.getElementById('password').value;
        const statusEl = document.getElementById('connect-status');
        // Create a loading spinner while connecting
        statusEl.innerHTML = `<div class="d-flex align-items-center"><span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Connecting...</div>`;

        // Send the connection request to the server
        const res = await fetch('/connect', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ssid, password})
        });

        // Parse the response from the server and report the success or failure
        const data = await res.json();
        statusEl.innerHTML = '';
        if (data.error) {
            statusEl.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        } else {
            statusEl.innerHTML = `<div class="alert alert-success">Connected successfully: ${data.output}</div>`;
        }
    }

    // Fetch the current SSID when the page loads
    fetchCurrentSSID();
</script>
</body>
</html>
